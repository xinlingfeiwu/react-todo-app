# åº”ç”¨è‡ªåŠ¨æ›´æ–°åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ğŸš€ åŠŸèƒ½æ¦‚è¿°

ä¸ºReact Todoåº”ç”¨æ·»åŠ äº†æ™ºèƒ½çš„è‡ªåŠ¨æ›´æ–°æ£€æµ‹å’Œæç¤ºåŠŸèƒ½ï¼Œå½“æœåŠ¡å™¨éƒ¨ç½²æ–°ç‰ˆæœ¬åï¼Œç”¨æˆ·ä¼šè‡ªåŠ¨æ”¶åˆ°æ›´æ–°æé†’ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

### ğŸ” è‡ªåŠ¨æ£€æµ‹

- **ç‰ˆæœ¬ç›‘æ§**: æ¯5åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡æœåŠ¡å™¨ç‰ˆæœ¬
- **æ™ºèƒ½å¯¹æ¯”**: å¯¹æ¯”ç‰ˆæœ¬å·å’Œæ„å»ºå“ˆå¸Œï¼Œç²¾ç¡®æ£€æµ‹æ›´æ–°
- **ç½‘ç»œä¼˜åŒ–**: è‡ªåŠ¨å¤„ç†ç½‘ç»œçŠ¶æ€å˜åŒ–å’Œé¡µé¢å¯è§æ€§
- **ç¼“å­˜æ§åˆ¶**: é˜²æ­¢æµè§ˆå™¨ç¼“å­˜å¹²æ‰°ç‰ˆæœ¬æ£€æµ‹

### ğŸ’¬ ç”¨æˆ·å‹å¥½

- **ä¼˜é›…æé†’**: å³ä¸Šè§’æ˜¾ç¤ºç²¾ç¾çš„æ›´æ–°é€šçŸ¥
- **è¯¦ç»†ä¿¡æ¯**: æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬å’Œæœ€æ–°ç‰ˆæœ¬å¯¹æ¯”
- **æ“ä½œé€‰æ‹©**: æä¾›"ç«‹å³æ›´æ–°"å’Œ"ç¨åæé†’"é€‰é¡¹
- **è§†è§‰åé¦ˆ**: æ›´æ–°è¿‡ç¨‹ä¸­æ˜¾ç¤ºè¿›åº¦å’ŒçŠ¶æ€

### ğŸ› ï¸ å¼€å‘å‹å¥½

- **ç¯å¢ƒæ„ŸçŸ¥**: å¼€å‘ç¯å¢ƒä¸‹æä¾›æ‰‹åŠ¨æ£€æŸ¥æŒ‰é’®
- **è°ƒè¯•ä¿¡æ¯**: è¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—å’Œé”™è¯¯æç¤º
- **å¯é…ç½®**: çµæ´»çš„é…ç½®é€‰é¡¹å’Œæ£€æŸ¥é—´éš”

## ğŸ“ æ–‡ä»¶ç»“æ„

```

src/
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useAppUpdate.js          # æ›´æ–°æ£€æµ‹æ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ AppUpdateNotification.jsx # æ›´æ–°æç¤ºUIç»„ä»¶
â”‚   â””â”€â”€ index.js                 # ç»„ä»¶å¯¼å‡º
â”œâ”€â”€ styles/components/
â”‚   â””â”€â”€ AppUpdateNotification.css # æ›´æ–°é€šçŸ¥æ ·å¼
â””â”€â”€ constants/
    â””â”€â”€ version.js               # ç‰ˆæœ¬ä¿¡æ¯å¸¸é‡(è‡ªåŠ¨ç”Ÿæˆ)

scripts/
â””â”€â”€ generate-version.sh          # ç‰ˆæœ¬ä¿¡æ¯ç”Ÿæˆè„šæœ¬

public/
â””â”€â”€ version.json                 # æœåŠ¡å™¨ç‰ˆæœ¬ä¿¡æ¯(è‡ªåŠ¨ç”Ÿæˆ)

```

## ğŸ”§ å·¥ä½œåŸç†

### 1. ç‰ˆæœ¬ä¿¡æ¯ç”Ÿæˆ

```bash

# æ„å»ºæ—¶è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯

npm run build

```

ç”Ÿæˆçš„ `version.json`:

```json

{
  "version": "1.0.0",
  "buildTime": "2024-01-15T10:30:00.000Z",
  "buildHash": "abc123def456",
  "timestamp": 1705312200000,
  "git": {
    "hash": "a1b2c3d",
    "branch": "main",
    "tag": "v1.0.0"
  }
}

```

### 2. å®¢æˆ·ç«¯æ£€æµ‹æµç¨‹

```mermaid

graph TD
    A[åº”ç”¨å¯åŠ¨] --> B[åˆå§‹åŒ–useAppUpdate]
    B --> C[å¯åŠ¨å®šæ—¶æ£€æŸ¥]
    C --> D[è·å–æœåŠ¡å™¨version.json]
    D --> E{ç‰ˆæœ¬æ˜¯å¦å˜åŒ–?}
    E -->|æ˜¯| F[æ˜¾ç¤ºæ›´æ–°æé†’]
    E -->|å¦| G[ç»§ç»­å®šæ—¶æ£€æŸ¥]
    F --> H{ç”¨æˆ·é€‰æ‹©?}
    H -->|ç«‹å³æ›´æ–°| I[æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°é¡µé¢]
    H -->|ç¨åæé†’| J[æš‚æ—¶éšè—æé†’]

```

### 3. æ›´æ–°æ£€æµ‹æœºåˆ¶

- **ä¸»è¦æ–¹æ³•**: å¯¹æ¯”æœåŠ¡å™¨ `version.json` å’Œæœ¬åœ°ç‰ˆæœ¬
- **å¤‡ç”¨æ–¹æ³•**: æ£€æŸ¥é¡µé¢ETagå’ŒLast-Modifiedå¤´
- **é˜²é¢‘ç¹**: æœ€å°æ£€æŸ¥é—´éš”1åˆ†é’Ÿ
- **æ™ºèƒ½é‡è¯•**: ç½‘ç»œé”™è¯¯æ—¶è‡ªåŠ¨é‡è¯•

## ğŸ“± ç”¨æˆ·ç•Œé¢

### æ›´æ–°é€šçŸ¥å¤–è§‚

```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„  åº”ç”¨æœ‰æ–°ç‰ˆæœ¬                     â”‚
â”‚     å‘ç°æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œæ›´æ–°åå¯äº«å—     â”‚
â”‚     æœ€æ–°åŠŸèƒ½å’Œä¿®å¤ã€‚                 â”‚
â”‚                                     â”‚
â”‚ ğŸ“‹ å½“å‰ç‰ˆæœ¬: 1.0.0                  â”‚
â”‚ ğŸ†• æœ€æ–°ç‰ˆæœ¬: 1.0.1                  â”‚
â”‚                                     â”‚
â”‚           [ç¨å] [ç«‹å³æ›´æ–°]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

### æ›´æ–°çŠ¶æ€

- **æ£€æŸ¥ä¸­**: æ˜¾ç¤ºæ—‹è½¬å›¾æ ‡å’Œ"æ£€æŸ¥æ›´æ–°ä¸­..."
- **æ›´æ–°ä¸­**: æ˜¾ç¤ºè¿›åº¦æ¡å’Œ"æ­£åœ¨æ›´æ–°åº”ç”¨ï¼Œè¯·ç¨å€™..."
- **å®Œæˆ**: è‡ªåŠ¨åˆ·æ–°é¡µé¢åˆ°æ–°ç‰ˆæœ¬

## âš™ï¸ é…ç½®é€‰é¡¹

åœ¨ `useAppUpdate.js` ä¸­å¯ä»¥è°ƒæ•´çš„é…ç½®:

```javascript

const config = {
  checkInterval: 5 * 60 * 1000,    // æ£€æŸ¥é—´éš”(æ¯«ç§’)
  versionEndpoint: '/version.json', // ç‰ˆæœ¬ä¿¡æ¯ç«¯ç‚¹
  minCheckInterval: 60 * 1000,     // æœ€å°æ£€æŸ¥é—´éš”
  retryDelay: 30 * 1000,           // é‡è¯•å»¶è¿Ÿ
  enableAutoCheck: true,           // æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ£€æŸ¥
};

```

## ğŸš€ éƒ¨ç½²é›†æˆ

### è‡ªåŠ¨éƒ¨ç½² (æ¨è)

éƒ¨ç½²è„šæœ¬å·²è‡ªåŠ¨é›†æˆç‰ˆæœ¬ç”ŸæˆåŠŸèƒ½:

```bash

# ä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯

./deploy/almalinux-deploy.sh -d todo.ylingtech.com -a todo-app

```

### æ‰‹åŠ¨éƒ¨ç½²

```bash

# 1. ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯

npm run generate-version

# 2. æ„å»ºåº”ç”¨

npm run build

# 3. éƒ¨ç½²åˆ°æœåŠ¡å™¨

# ç¡®ä¿ dist/version.json è¢«å¤åˆ¶åˆ°webç›®å½•

```

### éªŒè¯éƒ¨ç½²

```bash

# æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯æ˜¯å¦å¯è®¿é—®

curl https://your-domain.com/version.json

# åº”è¯¥è¿”å›ç±»ä¼¼:

# {"version":"1.0.0","buildTime":"2024-01-15T10:30:00.000Z",...}

```

## ğŸ” æµ‹è¯•åŠŸèƒ½

### å¼€å‘ç¯å¢ƒæµ‹è¯•

1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨: `npm run dev`
2. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
3. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ä¸­çš„ç‰ˆæœ¬æ£€æµ‹ä¿¡æ¯
4. åœ¨å¼€å‘æ¨¡å¼ä¸‹ä¼šæ˜¾ç¤º"æ‰‹åŠ¨æ£€æŸ¥"æŒ‰é’®

### ç”Ÿäº§ç¯å¢ƒæµ‹è¯•

1. éƒ¨ç½²å½“å‰ç‰ˆæœ¬åˆ°æœåŠ¡å™¨
2. ä¿®æ”¹ç‰ˆæœ¬å·: `package.json` ä¸­çš„ `version` å­—æ®µ
3. é‡æ–°æ„å»ºå¹¶éƒ¨ç½²: `npm run build`
4. ç­‰å¾…5åˆ†é’Ÿæˆ–åˆ·æ–°é¡µé¢ï¼Œåº”è¯¥çœ‹åˆ°æ›´æ–°æé†’

### æ¨¡æ‹Ÿæµ‹è¯•

```javascript

// åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­æ¨¡æ‹Ÿç‰ˆæœ¬æ›´æ–°
localStorage.setItem('app_update_available', JSON.stringify({
  currentVersion: '1.0.0',
  latestVersion: '1.0.1',
  detectedAt: Date.now()
}));

// ç„¶ååˆ·æ–°é¡µé¢
location.reload();

```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æ›´æ–°æé†’ä¸æ˜¾ç¤º

**å¯èƒ½åŸå› **:

- `version.json` æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®
- ç‰ˆæœ¬å·æ²¡æœ‰å˜åŒ–
- æµè§ˆå™¨ç¼“å­˜é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:

```bash

# æ£€æŸ¥ç‰ˆæœ¬æ–‡ä»¶

curl https://your-domain.com/version.json

# æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

# æˆ–åœ¨æµè§ˆå™¨ä¸­æŒ‰ Ctrl+Shift+R å¼ºåˆ¶åˆ·æ–°

```

#### 2. ç‰ˆæœ¬æ£€æµ‹å¤±è´¥

**å¯èƒ½åŸå› **:

- ç½‘ç»œè¿æ¥é—®é¢˜
- CORS ç­–ç•¥é™åˆ¶
- æœåŠ¡å™¨é…ç½®é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:

```nginx

# Nginx é…ç½®ä¸­æ·»åŠ  CORS å¤´

location /version.json {
    add_header Access-Control-Allow-Origin "*";
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}

```

#### 3. æ›´æ–°åä»æ˜¾ç¤ºæ—§ç‰ˆæœ¬

**å¯èƒ½åŸå› **:

- æµè§ˆå™¨ç¼“å­˜
- CDN ç¼“å­˜
- Service Worker ç¼“å­˜

**è§£å†³æ–¹æ¡ˆ**:

- æ›´æ–°åŠŸèƒ½ä¼šè‡ªåŠ¨æ¸…é™¤ç¼“å­˜
- æ‰‹åŠ¨æ¸…é™¤: æµè§ˆå™¨è®¾ç½® â†’ æ¸…é™¤æµè§ˆæ•°æ®
- æ£€æŸ¥CDNç¼“å­˜ç­–ç•¥

### è°ƒè¯•ä¿¡æ¯

åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­æŸ¥çœ‹:

```javascript

// æŸ¥çœ‹å½“å‰ç‰ˆæœ¬ä¿¡æ¯
console.log('App Version:', window.__APP_VERSION__);
console.log('Build Hash:', window.__BUILD_HASH__);

// æ‰‹åŠ¨è§¦å‘ç‰ˆæœ¬æ£€æŸ¥
// åœ¨ç»„ä»¶ä¸­è°ƒç”¨ checkForUpdate()

```

## ğŸ“ˆ é«˜çº§åŠŸèƒ½

### è‡ªå®šä¹‰æ›´æ–°é€»è¾‘

å¯ä»¥æ‰©å±• `useAppUpdate` hook æ¥æ·»åŠ :

- å¢é‡æ›´æ–°æ”¯æŒ
- æ›´æ–°å†…å®¹é¢„è§ˆ
- ç”¨æˆ·åå¥½è®¾ç½®
- æ›´æ–°ç»Ÿè®¡åˆ†æ

### ä¸CI/CDé›†æˆ

```yaml

# GitHub Actions ç¤ºä¾‹

name: Deploy with Version Update
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2
      - name: Setup Node.js

        uses: actions/setup-node@v2
        with:
          node-version: '18'

      - name: Install dependencies

        run: npm install

      - name: Generate version info

        run: npm run generate-version

      - name: Build application

        run: npm run build

      - name: Deploy to server

        run: ./deploy/deploy.sh

```

## ğŸ“š APIå‚è€ƒ

### useAppUpdate Hook

```javascript

const {
  hasUpdate,          // boolean - æ˜¯å¦æœ‰æ›´æ–°
  currentVersion,     // string - å½“å‰ç‰ˆæœ¬
  latestVersion,      // string - æœ€æ–°ç‰ˆæœ¬
  isChecking,         // boolean - æ˜¯å¦æ­£åœ¨æ£€æŸ¥
  checkForUpdate,     // function - æ‰‹åŠ¨æ£€æŸ¥æ›´æ–°
  applyUpdate,        // function - åº”ç”¨æ›´æ–°
  dismissUpdate,      // function - å¿½ç•¥æ›´æ–°
  startAutoCheck,     // function - å¼€å§‹è‡ªåŠ¨æ£€æŸ¥
  stopAutoCheck       // function - åœæ­¢è‡ªåŠ¨æ£€æŸ¥
} = useAppUpdate();

```

### ç‰ˆæœ¬ä¿¡æ¯æ ¼å¼

```typescript

interface VersionInfo {
  name: string;
  version: string;
  buildTime: string;
  buildTimestamp: number;
  buildHash: string;
  git: {
    hash: string;
    branch: string;
    tag: string;
  };
  timestamp: number;
}

```

## ğŸ¯ æœ€ä½³å®è·µ

1. **ç‰ˆæœ¬å·ç®¡ç†**: ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬å· (Semantic Versioning)
2. **éƒ¨ç½²é¢‘ç‡**: å»ºè®®å°ç‰ˆæœ¬é¢‘ç¹å‘å¸ƒï¼Œå¤§ç‰ˆæœ¬è°¨æ…å‘å¸ƒ
3. **ç”¨æˆ·ä½“éªŒ**: åœ¨åˆé€‚çš„æ—¶æœºæé†’ç”¨æˆ·æ›´æ–°ï¼Œé¿å…æ‰“æ–­å·¥ä½œæµ
4. **ç¼“å­˜ç­–ç•¥**: è®¾ç½®åˆç†çš„ç¼“å­˜ç­–ç•¥ï¼Œå¹³è¡¡æ€§èƒ½å’Œæ›´æ–°åŠæ—¶æ€§
5. **é”™è¯¯å¤„ç†**: ä¼˜é›…å¤„ç†ç½‘ç»œé”™è¯¯å’Œç‰ˆæœ¬æ£€æµ‹å¤±è´¥çš„æƒ…å†µ

---

## ğŸ‰ åŠŸèƒ½å®Œæˆ

ç°åœ¨æ‚¨çš„React Todoåº”ç”¨å…·å¤‡äº†æ™ºèƒ½çš„è‡ªåŠ¨æ›´æ–°æ£€æµ‹åŠŸèƒ½ï¼š

âœ… **è‡ªåŠ¨æ£€æµ‹**: å®šæœŸæ£€æŸ¥æœåŠ¡å™¨ç‰ˆæœ¬æ›´æ–°
âœ… **å‹å¥½æé†’**: ä¼˜é›…çš„æ›´æ–°é€šçŸ¥ç•Œé¢
âœ… **ä¸€é”®æ›´æ–°**: ç”¨æˆ·ç‚¹å‡»å³å¯æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
âœ… **å¼€å‘å‹å¥½**: å®Œæ•´çš„è°ƒè¯•å’Œæµ‹è¯•å·¥å…·
âœ… **éƒ¨ç½²é›†æˆ**: ä¸ç°æœ‰éƒ¨ç½²æµç¨‹æ— ç¼é›†æˆ

ç”¨æˆ·å†ä¹Ÿä¸ä¼šé”™è¿‡ä»»ä½•æ–°åŠŸèƒ½å’Œé‡è¦ä¿®å¤äº†ï¼ğŸš€
